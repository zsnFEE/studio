{"version":3,"file":"plugin.mjs","sources":["../../../components/loading/plugin.tsx"],"sourcesContent":["import { App, Plugin, createVNode, defineComponent, h, reactive, render, AppContext } from 'vue';\nimport { merge } from 'lodash-es';\nimport LoadingComponent from './loading';\nimport { usePrefixClass } from '@tdesign/shared-hooks';\nimport { getAttach, removeClass, addClass } from '@tdesign/shared-utils';\nimport { TdLoadingProps, LoadingInstance, LoadingMethod } from './type';\n\nlet fullScreenLoadingInstance: LoadingInstance = null;\n\nfunction mergeDefaultProps(props: TdLoadingProps): TdLoadingProps {\n  const options: TdLoadingProps = merge(\n    {\n      fullscreen: false,\n      attach: 'body',\n      loading: true,\n      preventScrollThrough: true,\n    },\n    props,\n  );\n\n  return options;\n}\n\nfunction createLoading(props: TdLoadingProps, context?: AppContext): LoadingInstance {\n  const mergedProps = mergeDefaultProps(props);\n\n  if (mergedProps.fullscreen && fullScreenLoadingInstance) {\n    return fullScreenLoadingInstance;\n  }\n\n  const component = defineComponent({\n    setup() {\n      const loadingOptions = reactive(mergedProps);\n\n      return () => h(LoadingComponent, loadingOptions);\n    },\n  });\n\n  const attach = getAttach(mergedProps.fullscreen ? 'body' : mergedProps.attach);\n\n  const instance = createVNode(component);\n\n  // eslint-disable-next-line no-underscore-dangle\n  if (context ?? LoadingPlugin._context) {\n    // eslint-disable-next-line no-underscore-dangle\n    instance.appContext = context ?? LoadingPlugin._context;\n  }\n\n  const wrapper = document.createElement('div');\n  render(instance, wrapper);\n\n  const parentRelativeClass = usePrefixClass('loading__parent--relative').value;\n  const lockClass = usePrefixClass('loading--lock');\n  const lockFullscreen = mergedProps.preventScrollThrough && mergedProps.fullscreen;\n\n  if (lockFullscreen) {\n    addClass(document.body, lockClass.value);\n  }\n\n  if (attach) {\n    addClass(attach, parentRelativeClass);\n  } else {\n    console.error('attach is not exist');\n  }\n\n  const loadingInstance: LoadingInstance = {\n    hide: () => {\n      removeClass(attach, parentRelativeClass);\n      removeClass(document.body, lockClass.value);\n      // 卸载组件渲染\n      render(null, wrapper);\n      wrapper.remove();\n    },\n  };\n  return loadingInstance;\n}\n\nfunction produceLoading(props: boolean | TdLoadingProps, context?: AppContext): LoadingInstance {\n  // 全屏加载\n  if (props === true) {\n    fullScreenLoadingInstance = createLoading(\n      {\n        fullscreen: true,\n        loading: true,\n        attach: 'body',\n        preventScrollThrough: true,\n      },\n      context,\n    );\n    return fullScreenLoadingInstance;\n  }\n\n  if (props === false) {\n    // 销毁全屏实例\n    fullScreenLoadingInstance?.hide();\n    fullScreenLoadingInstance = null;\n    return;\n  }\n  return createLoading(props);\n}\n\nexport type LoadingPluginType = Plugin &\n  LoadingMethod & {\n    _context?: AppContext;\n  };\n\nexport const LoadingPlugin: LoadingPluginType = produceLoading as LoadingPluginType;\n\nLoadingPlugin.install = (app: App) => {\n  // eslint-disable-next-line no-param-reassign\n  app.config.globalProperties.$loading = produceLoading;\n  // eslint-disable-next-line no-underscore-dangle\n  LoadingPlugin._context = app._context;\n};\n\nexport default LoadingPlugin;\n"],"names":["fullScreenLoadingInstance","mergeDefaultProps","props","options","merge","fullscreen","attach","loading","preventScrollThrough","createLoading","context","mergedProps","component","defineComponent","setup","loadingOptions","reactive","h","LoadingComponent","getAttach","instance","createVNode","LoadingPlugin","_context","appContext","wrapper","document","createElement","render","parentRelativeClass","usePrefixClass","value","lockClass","lockFullscreen","addClass","body","console","error","loadingInstance","hide","removeClass","remove","produceLoading","_fullScreenLoadingIns","install","app","config","globalProperties","$loading"],"mappings":"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"}